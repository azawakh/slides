<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-type" content="text/html; charset=utf-8"><meta name="theme-color" content="#3498db"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Introduction to CircleCI</title><meta property="og:title" content="Introduction to CircleCI"><meta property="og:type" content="article"><meta property="og:site_name" content="hagevvashi's slide"><link href="vendor.7.e88c63a702867065e72d.css" rel="stylesheet"><link href="main.4.d1f5e425371068a01915.css" rel="stylesheet"></head><body><div id="root"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="btn-sidebar" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg><article id="webslides"><section class="aligncenter title"><h1>Introduction to CircleCI@Ginza.js#7</h1></section><section class="aligncenter profile"><section><h2>üí™<!-- --> ME<!-- --> üí™</h2><br><div class="profile"><img src="https://s.gravatar.com/avatar/949e08dcc61f089a8f463f312ccd325c?size=200&amp;default=retro" alt="profile" class="profile-avatar"><h4 class="profile-name">Ota Naoto</h4><div class="sns-list"><div class="sns-list"><a href="https://github.com/hagevvashi" target="_blank"><i class="fab fa-github"></i></a></div></div><div class="profile-info"><p>A frontend engineer</p><p>Kakaku.com, Inc</p><p><img src="https://tblg.k-img.com/images/restaurant/logo/logo_tabelog_white.svg?1547477433" alt="Tabelog"></p></div></div></section></section><section class="aligncenter title outline"><h2>Outline</h2><ol><li>Argument: Using CircleCI in Frontend Development is very effortless and efficient</li><li>CASE1: Automated storybook deployment to AWS S3</li><li>CASE2: Support for checking the image of the changed component on Pull Request</li><li>CASE3: Api spec document deployment and checking on the PR</li><li>Conclusion: You should now enable CircleCI or other CI tools integration to your repository</li></ol></section><section class="aligncenter title"><h2>Using CircleCI in Frontend Development is very effortless and efficient</h2></section><section class="aligncenter what-is-circleci"><h3>What is CircleCI?</h3><p>A kind of CI tools</p><ul><li><img src="https://d3r49iyjzglexf.cloudfront.net/ja/circleci-logo-stacked-fb-2bbc2f98672809be0a4e917efde89548d5ee527dabbece4384317c540d2c3984.png" alt="Logo of CircleCI"></li><li><img src="https://cdn.worldvectorlogo.com/logos/travis-ci.svg" alt="Logo of TravisCI"></li></ul></section><section class="aligncenter"><h3>What problems does CircleCI solve?</h3><ul><li>Manual execution of unit / e2e test</li><li>Manual execution of Linting</li><li>Manual checking of components list</li><li>Manual execution of deployment</li></ul><p>and so on</p></section><section class="aligncenter title"><h2>CASE1: Automated storybook deployment to AWS S3</h2></section><section class="aligncenter what-is-storybook"><h3>What is Storybook?</h3><p>A kind of ui component list management tool</p><p>https://storybook.grommet.io/</p><iframe src="https://storybook.grommet.io/?path=/story/all--all"></iframe></section><section class="aligncenter storybook-deploy"><h3>Storybook deployment to AWS s3</h3><img src="22a00b39dbb9c17decd2995aafcbbda0.webp"></section><section class="aligncenter circleci-config"><h3>CircleCI config</h3><pre><code class="language-yaml">workflows:
  version: 2
  setup_and_ci:
    jobs:
      - storybook-prod:
          requires:
            - lint
            - test
          filters:
            branches:
              only:
                - master
</code></pre></section><section class="aligncenter circleci-conifg"><h3>CircleCI config</h3><pre><code class="language-yaml">steps:
  - run:
      name: Run storybook build
      command: yarn build-storybook
  - run:
      name: Install aws cli
      command: sudo apt-get install awscli
  - run:
      name: upload document
      command: |
        aws configure set preview.cloudfront true
        aws s3 cp ${DIRNAME} s3://${S3_BUCKET}/${CIRCLE_PROJECT_REPONAME} --recursive
  - run:
      name: clear cache of CloudFront
      command: |
        aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --paths /${CIRCLE_PROJECT_REPONAME}/*
</code></pre></section><section class="aligncenter title"><h2>CASE2: support for checking the image of the changed component on Pull Request</h2></section><section class="aligncenter storybook-artifacts"><h3>Storybook deployment to artifacts</h3><img src="d8ba6e41538dbb1be341d5ab42ba4dbf.webp"></section><section class="aligncenter storybook-artifacts"><h3>Pull Request comment</h3><img src="6c646a02115e8276d71942d75ba73169.webp"></section><section class="aligncenter storybook-artifacts"><h3>Flow image</h3><ol><li>Output the greped difference</li><li>Generate urls and comment based on difference</li><li>Post the comment to the pull request</li></ol></section><section class="aligncenter storybook-artifacts"><h3>1. Output the greped difference</h3><pre><code class="language-bash">PULL_REQUEST_ID=$(echo $CIRCLE_PULL_REQUEST | awk -F&#x27;/&#x27; &#x27;{print $NF}&#x27;)

TARGET_BRANCH=$(curl \
  &quot;https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/pulls/$PULL_REQUEST_ID?access_token=$GITHUB_API_TOKEN&quot; \
  | jq -r &#x27;.base.ref&#x27;)

git diff origin/${TARGET_BRANCH}...HEAD --name-only | grep &#x27;components.*\(vue\|stories\.ts\)&#x27;
</code></pre></section><section class="aligncenter"><h3>2. Generate urls and comment based on difference</h3><h4>Generate hirerarchy</h4><pre><code class="language-ts">export const generateHierarchyFromFilepath = (filePath: string): string =&gt; {
  const re = filePath.match(
    /.*?components\/(.*?)\/(index\.vue|index\.stories\.ts)?$/
  )
  if (!re) {
    throw new Error(&#x27;Passed path is invalid&#x27;)
  }
  return re[1]
}
</code></pre><p>also we can use this function on the stories</p><pre><code class="language-ts">import base from &#x27;paths.macro&#x27;
import { generateHierarchyFromFilepath } from &#x27;~/utils&#x27;

storiesOf(generateHierarchyFromFilepath(base), module)
  .add(&#x27;foo&#x27;, () =&gt; ({}))
</code></pre></section><section class="aligncenter storybook-artifacts"><h3>3. Post the comment to the pull request</h3><pre><code class="language-ts">const endpoint =
  `https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/issues/${PULL_REQUEST_ID}/comments`

await axios.post(
  endpoint,
  {
    body: comment
  },
  {
    headers: {
      Authorization: `Bearer ${GITHUB_API_TOKEN}`,
      Accept: &#x27;application/vnd.github.v3.html+json&#x27;
    }
  }
)
</code></pre></section><section class="aligncenter storybook-artifacts"><h3>Whole Code Image</h3><pre><code class="language-ts">import { generateHierarchyFromFilepath } from &#x27;../utils&#x27;

const getModifiedFilesFromStdin = (): Promise&lt;string[]&gt;

const generateStorybookUrlFromHierarchy = (hierarchy: string): string

const generateComment = (
  modifiedStories: { hierarchy: string; url: string }[]
): string

const postCommentToPr = async (comment: string): Promise&lt;void&gt;

;(async (): Promise&lt;void&gt; =&gt; {
  const modifiedFiles: string[] = await getModifiedFilesFromStdin()

  if (modifiedFiles.length === 0) {
    process.exit()
  }

  const modifiedStories = modifiedFiles
    .map(generateHierarchyFromFilepath)
    .filter((item, index, array) =&gt; array.indexOf(item) === index)
    .map((hierarchy) =&gt; ({
      hierarchy,
      url: generateStorybookUrlFromHierarchy(hierarchy)
    }))

  const comment = generateComment(modifiedStories)
  postCommentToPr(comment)
})()
</code></pre></section><section class="aligncenter storybook-artifacts"><h3>Reference</h3><ul><li><a href="https://qiita.com/resessh/items/38ef6492d0cf21facec8">PR„Åî„Å®„Å´CI„ÅßStorybook„Çí„Éì„É´„Éâ„Åó„Å¶„Éá„Ç∂„Ç§„Éä„Éº„Å®„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥„Åæ„Åß‰Ωú„Å£„Å¶„ÅÑ„ÅèË©±</a></li></ul></section><section class="aligncenter title"><h2>CASE3: Api spec document deployment and checking on the PR</h2></section><section class="aligncenter"><h3>What is OpenAPI?</h3><blockquote><p>OpenAPI Specification (formerly Swagger Specification) is an API description format for REST APIs.</p></blockquote></section><section class="aligncenter"><h3>What problems does OpenAPI solve?</h3><ul><li>Writing document manually<ul><li>It&#x27;s hard to write a table by hand</li><li>It&#x27;s hard to write sample json by hand</li></ul></li><li>Inconsistent document format</li><li>Duplicate description</li></ul></section><section class="aligncenter"><h3>The same idea as storybook deployment</h3><ul><li>Merge to master branch triggers story book deployment job to AWS S3</li><li>Push on branch associated with pull request triggers deployment job to artifacts</li></ul></section><section class="aligncenter openapi-deploy"><h3>How to visualize document?</h3><p>Using <a href="https://swagger.io/tools/swagger-ui/">Swagger UI</a></p><iframe src="https://petstore.swagger.io/?_ga=2.93052829.1075228615.1575361129-2002843474.1575361129"></iframe></section><section class="aligncenter"><h3>Preparing Swagger UI distribution files</h3><pre><code class="language-yml">version: 2.1
executors:
  swagger_ui:
    docker:
      - image: swaggerapi/swagger-ui
jobs:
  prepare_docs:
    steps:
      - run:
          name: prepare openapi docs
          command: |
            sed -i &quot;s|https://petstore.swagger.io/v2/swagger.json|openapi.yml|g&quot; /usr/share/nginx/html/index.html
            mv /usr/share/nginx/html docs
            cp openapi.yml docs
</code></pre></section><section class="aligncenter"><h3>‚ö†<!-- --> Point to be noted<!-- --> ‚ö†</h3><p>If the &quot;Only build pull requests&quot; setting is not enabled,</p><p>when the pull request creation timing is late,</p><p>the process of commenting on the pull request fails.</p></section><section class="aligncenter"><h3>If you really want to turn that setting off</h3><p>You can refer to this article</p><ul><li><a href="https://qiita.com/yasuhiroki/items/bddb3f51bf3439652c0c">CircleCI„ÅÆOnly build pull requests„Çíoff„Å´„Åó„Å¶„ÇÇ„Éó„É´„É™„ÇØ„Ç®„Çπ„Éà„Çí‰Ωú„Å£„Åü„ÇâJob„ÇíÂÆüË°å„Åó„Åü„ÅÑ</a></li></ul></section><section class="aligncenter title conclusion"><h2>Conclusion</h2><p>You should now enable CircleCI or other CI tools integration to your repository</p><p><img src="https://images.contentstack.io/v3/assets/blt300387d93dabf50e/blt20392bf5fa78edf7/5bbf935efe0adfe212184907/download" alt="Continuos Integration &amp; Delivery"></p><p>The <a href="https://landscape.cncf.io/">CNCF landscape for CICD tools</a>.</p></section><section class="aligncenter hiring"><header style="border-bottom:solid 1px;border-color:var(--color-yellow);color:var(--color-yellow);text-align:left;font-size:xx-large">At Last</header><div style="display:flex;flex-direction:row;align-items:center;min-height:70rem"><div style="flex-grow:1"><img src="4d171775847180d4d1cfeca6028026c7.webp"></div><div style="flex-grow:1"><h2 style="color:var(--color-red);font-size:5.4rem">We are hiring!</h2><div style="margin:7rem 0"><p>WEB„ÄÅ„Ç¢„Éó„É™„ÄÅ„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Ç®„É≥„Ç∏„Éã„Ç¢„Å™„Å©Êßò„ÄÖ„Å™ËÅ∑Á®Æ„Åß„Ç®„É≥„Ç∏„Éã„Ç¢ÂãüÈõÜ‰∏≠„Åß„ÅôÔºÅ</p><p>„Ç´„Ç∏„É•„Ç¢„É´Èù¢Ë´áÔºà„Ç™„Éï„Ç£„ÇπË®™ÂïèÔºâÊ≠ìËøé„Åß„ÅôÔºÅ</p><p><a href="https://www.wantedly.com/projects/254221">WANTEDLY„ÅØ„Åì„Å°„ÇâÔºÅ</a></p></div></div></div><div style="position:absolute;bottom:54px;right:0;z-index:4;padding:0 2.4rem 0 0;background:rgba(255,255,255,1)"><img src="de802ae92aae61304904ae8c23ca8d9f.webp" style="width:inherit"></div><footer style="text-align:left;border-top:solid 1px;border-color:var(--color-yellow)">Copyright ¬© Kakaku.com Inc. All Rights Reserved.</footer></section><section class="aligncenter end"><h1>Thanks for all</h1><br><div class="sns-list sns-list-end"><a href="https://github.com/hagevvashi" target="_blank"><i class="fab fa-github"></i></a></div></section></article></div><script type="text/javascript" src="runtime.428dfa76538a310e0f4d.bundle.js"></script><script type="text/javascript" src="vendor.7.e88c63a702867065e72d.bundle.js"></script><script type="text/javascript" src="main.4.d1f5e425371068a01915.bundle.js"></script></body></html>